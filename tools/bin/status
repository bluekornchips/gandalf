#!/usr/bin/env bash
# Gandalf Status - Server status monitoring and health checking

set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
readonly GANDALF_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
readonly GANDALF_HOME="${GANDALF_HOME:-$HOME/.gandalf}"

# Find available server installations
get_available_servers() {
	local servers_dir="$GANDALF_HOME/servers"

	if [[ ! -d "$servers_dir" ]]; then
		return 0
	fi

	for server_path in "$servers_dir"/*; do
		if [[ -d "$server_path" && -f "$server_path/gandalf-server" ]]; then
			basename "$server_path"
		fi
	done
}

# Get the path to a server installation
get_server_path() {
	local server_name="$1"
	local servers_dir="$GANDALF_HOME/servers"

	if [[ -d "$servers_dir/$server_name" ]]; then
		echo "$servers_dir/$server_name"
		return 0
	fi

	return 1
}

# Get server version
get_server_version() {
	local server_path="$1"
	if [[ -f "$server_path/VERSION" ]]; then
		cat "$server_path/VERSION"
	else
		echo "unknown"
	fi
}

# Check if server is healthy with a simple JSON-RPC request
check_server_health() {
	local server_name="$1"
	local timeout_duration=3

	# Try to get server status via JSON-RPC
	local health_response
	if health_response=$(timeout "$timeout_duration" bash -c '
		echo "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"tools/list\",\"params\":{}}" | 
		'$GANDALF_ROOT'/gandalf run --server "'$server_name'" 2>/dev/null
	' 2>/dev/null); then
		if echo "$health_response" | jq -e '.result' >/dev/null 2>&1; then
			echo "healthy"
			return 0
		fi
	fi

	echo "unavailable"
	return 1
}

# Get server PID (simplified - look for python processes with gandalf)
get_server_pid() {
	local server_name="$1"
	# Look for gandalf server processes
	pgrep -f "gandalf.*server.*$server_name" 2>/dev/null | head -n1 || echo "none"
}

# Get default server name (first available or global)
get_default_server() {
	local available_servers
	available_servers=$(get_available_servers)

	if [[ -n "$available_servers" ]]; then
		echo "$available_servers" | head -n1
	elif [[ -f "$GANDALF_ROOT/server/src/main.py" ]]; then
		echo "repository"
	else
		echo "none"
	fi
}

show_help() {
	cat <<EOH
Gandalf Status - Server status monitoring and health checking

Usage: $0 [OPTIONS]

Options:
    --servers           List all servers with names, versions, and locations
    --server-name NAME  Check status of specific server (default: global)
    -a, --available     List only healthy/available servers
    --help, -h          Show this help message

Helper Commands (for internal use):
    path SERVER_NAME    Get path to specific server installation
    available-names     Get available server names only

Examples:
    $0                    # Show default server status
    $0 --servers          # List all server installations
    $0 --server-name global  # Check specific server status
    $0 --available        # List only healthy servers

EOH
}

# List all servers with details
list_all_servers() {
	local servers_dir="$GANDALF_HOME/servers"
	local found_servers=false

	echo "Server Installations:"
	printf "%-15s %-10s %-50s %s\n" "Name" "Version" "Location" "Status"
	printf "%-15s %-10s %-50s %s\n" "----" "-------" "--------" "------"

	# List server installations
	if [[ -d "$servers_dir" ]]; then
		for server_path in "$servers_dir"/*; do
			if [[ -d "$server_path" ]]; then
				local server_name
				server_name="$(basename "$server_path")"
				local version
				version=$(get_server_version "$server_path")
				local status="installed"

				if [[ ! -f "$server_path/gandalf-server" || ! -x "$server_path/gandalf-server" ]]; then
					status="broken"
				fi

				printf "%-15s %-10s %-50s %s\n" "$server_name" "$version" "$server_path" "$status"
				found_servers=true
			fi
		done
	fi

	# Show repository version if available
	if [[ -f "$GANDALF_ROOT/server/src/main.py" ]]; then
		printf "%-15s %-10s %-50s %s\n" "repository" "dev" "$GANDALF_ROOT/server" "installed"
		found_servers=true
	fi

	if [[ "$found_servers" != "true" ]]; then
		echo "No server installations found"
		echo "Run 'gandalf install' to create server installations"
	fi
}

# Show detailed status of a specific server
show_server_status() {
	local server_name="$1"
	local server_path=""
	local version="unknown"
	local location="unknown"

	if [[ "$server_name" == "repository" ]]; then
		if [[ -f "$GANDALF_ROOT/server/src/main.py" ]]; then
			location="$GANDALF_ROOT/server"
			version="dev"
		else
			echo "Error: Repository server not found"
			return 1
		fi
	else
		if server_path=$(get_server_path "$server_name" 2>/dev/null); then
			location="$server_path"
			version=$(get_server_version "$server_path")
		else
			echo "Error: Server '$server_name' not found"
			return 1
		fi
	fi

	# Get PID and health
	local pid
	pid=$(get_server_pid "$server_name")
	local health_status
	if health_status=$(check_server_health "$server_name" 2>/dev/null); then
		: # health_status already set
	else
		health_status="unavailable"
	fi

	echo "Server Status: $server_name"
	printf "  %-10s %s\n" "Name:" "$server_name"
	printf "  %-10s %s\n" "Version:" "$version"
	printf "  %-10s %s\n" "Location:" "$location"
	printf "  %-10s %s\n" "PID:" "$pid"
	printf "  %-10s %s\n" "Health:" "$health_status"
}

# List only available/healthy servers
list_available_servers() {
	local servers_dir="$GANDALF_HOME/servers"
	local available_found=false

	echo "Available Servers:"

	# Check server installations
	if [[ -d "$servers_dir" ]]; then
		for server_path in "$servers_dir"/*; do
			if [[ -d "$server_path" ]]; then
				local server_name
				server_name="$(basename "$server_path")"

				if [[ -f "$server_path/gandalf-server" && -x "$server_path/gandalf-server" ]]; then
					local health
					if health=$(check_server_health "$server_name" 2>/dev/null) && [[ "$health" == "healthy" ]]; then
						local version
						version=$(get_server_version "$server_path")
						echo " $server_name ($version) - healthy"
						available_found=true
					fi
				fi
			fi
		done
	fi

	# Check repository version
	if [[ -f "$GANDALF_ROOT/server/src/main.py" ]]; then
		local health
		if health=$(check_server_health "repository" 2>/dev/null) && [[ "$health" == "healthy" ]]; then
			echo " repository (dev) - healthy"
			available_found=true
		fi
	fi

	if [[ "$available_found" != "true" ]]; then
		echo " No healthy servers found"
	fi
}

main() {
	local show_servers=false
	local show_available=false
	local server_name=""

	# Handle helper commands first
	case "${1:-}" in
	path)
		if [[ -z "${2:-}" ]]; then
			echo "Error: Server name required for path command" >&2
			exit 1
		fi
		if [[ "$2" == "repository" ]]; then
			echo "$GANDALF_ROOT/server"
		elif server_path=$(get_server_path "$2" 2>/dev/null); then
			echo "$server_path"
		else
			exit 1
		fi
		exit 0
		;;
	available-names)
		get_available_servers
		exit 0
		;;
	esac

	while [[ $# -gt 0 ]]; do
		case "$1" in
		--servers)
			show_servers=true
			shift
			;;
		--server-name)
			server_name="$2"
			shift 2
			;;
		-a | --available)
			show_available=true
			shift
			;;
		--help | -h)
			show_help
			exit 0
			;;
		*)
			echo "Error: Unknown option: $1" >&2
			echo "Run '$0 --help' for usage information" >&2
			exit 1
			;;
		esac
	done

	# Validate exclusive options
	if [[ "$show_servers" == "true" ]] && [[ -n "$server_name" || "$show_available" == "true" ]]; then
		echo "Error: --servers cannot be used with other options" >&2
		exit 1
	fi

	# Execute based on options
	if [[ "$show_servers" == "true" ]]; then
		list_all_servers
	elif [[ "$show_available" == "true" ]]; then
		list_available_servers
	else
		# Show server status (default behavior)
		if [[ -z "$server_name" ]]; then
			server_name=$(get_default_server)
			if [[ "$server_name" == "none" ]]; then
				echo "Error: No servers available"
				exit 1
			fi
		fi
		show_server_status "$server_name"
	fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
	main "$@"
fi
